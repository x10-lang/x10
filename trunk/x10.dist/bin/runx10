#!/bin/bash
# Use to run an X10 program linked against PGAS in a single place
# Can also be used to invoke valgrind, gdb, etc
# Should work on Cygwin, Linux, Darwin, AIX

prog="$(readlink $0 2>&1)"
[ $? -eq 127 -o "$prog" = "" ] && prog="$0"
TOP="$(cd "$(dirname $prog)/.." && pwd)"

PATH="$PATH:."

if [ "`uname -s`" = "AIX" ] ; then
    # AIX: set up env vars needed for poe, run at 1 place (localhost) via poe
    unset MP_MSG_API MP_TASK_AFFINITY MP_EUIDEVICE MP_ADAPTER_USE MP_EUILIB MP_CPU_USE \
          MP_CSS_INTERRUPT MP_USE_BULK_XFER MP_EAGER_LIMIT MP_PULSE MP_POLLING_INTERVAL \
          MP_SHARED_MEMORY MP_SINGLE_THREAD MP_WAIT_MODE
    HOSTFILENAME=.hostlist.x10run.$$
    hostname > $HOSTFILENAME
    LAPI_USE_SHMEM="yes" poe "$@" -procs 1 -hostfile $HOSTFILENAME -msg_api lapi
    rm -f $HOSTFILENAME
else
    # Cygwin / Linux: set up env vars needed for PGAS sockets backend
    if [ -n "$CPUPROFILE" ] ; then
        export LD_PRELOAD="$LDPRELOAD /usr/lib/libprofiler.so"
    fi

    if [ -z "$PGASRT_HOME_NODE" ] ; then
        export PGASRT_HOME_NODE=127.0.0.1 
    fi
    if [ -n "$BE" -a -n "$OF" ] ; then
        export MP_CHILD="$BE" MP_PROCS="$OF"
    else
        export MP_CHILD=0 MP_PROCS=1 
    fi

    # Cygwin: add x10.dist/lib to PATH to pick up the shared libs
    if [[ "`uname -s`" = CYGWIN* ]] ; then
        export PATH="$PATH:$TOP/lib"
    fi

    exec "$@"
fi
